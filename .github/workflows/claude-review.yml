name: Claude Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Clone dotclaude configuration
        run: |
          git clone https://github.com/loadinglucian/dotclaude.git dotclaude

      - name: Setup Claude configuration symlinks
        run: |
          # Link global ~/.claude to dotclaude/
          ln -s "$GITHUB_WORKSPACE/dotclaude" "$HOME/.claude"

          # Link project .claude to dotclaude/deployer-php
          ln -s "$GITHUB_WORKSPACE/dotclaude/deployer-php" "$GITHUB_WORKSPACE/.claude"

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            <context>
            Repository: ${{ github.repository }}
            Pull Request: #${{ github.event.pull_request.number }}
            Title: ${{ github.event.pull_request.title }}
            Commit SHA: ${{ github.event.pull_request.head.sha }}

            You have access to custom agents via the Task tool, including `trace-agent` for deep static analysis.
            Follow CLAUDE.md for project conventions and quality standards.
            </context>

            <protocol>

              <step name="get-modified-files">
                Use `gh pr diff` to get the list of modified files in this PR.
                Categorize files:
                - Code files: *.php, *.js, *.ts, *.sh
                - Command files: app/Console/**/*Command.php
              </step>

              <step name="trace-analysis">
                For each modified code file, spawn trace-agent using the Task tool:
                - subagent_type: trace-agent
                - prompt: "Analyze {filepath} for bugs and issues. Return findings as JSON:
                  {
                    \"findings\": [
                      {\"path\": \"relative/file/path.php\", \"line\": 42, \"severity\": \"high|medium|low\", \"message\": \"Description\"}
                    ],
                    \"general\": [\"Issues without specific line numbers\"]
                  }"

                Run analyses in parallel where possible.
              </step>

              <step name="docs-check">
                For each modified command file (app/Console/**/*Command.php), spawn docs-agent:
                - subagent_type: docs-agent
                - prompt: "Check if documentation for {command_name} needs updating based on changes in {filepath}"

                Run in parallel with trace-analysis where possible.
              </step>

              <step name="collect-findings">
                Aggregate all findings from trace-agent results into:
                1. inline_comments: Array of {path, line, severity, message} for issues with specific locations
                2. general_issues: Array of strings for issues without line numbers
                3. doc_updates: Array of documentation findings from docs-agent
              </step>

              <step name="submit-review">
                Submit a GitHub code review with inline comments using the API.

                1. Build the review summary body:
                   ## Code Review Summary

                   **{X} inline comments** on {Y} files

                   ### General Issues
                   {List general_issues, or "None"}

                   ### Documentation
                   {List doc_updates, or "All docs up to date"}

                2. Build the comments array for inline comments. Each needs:
                   - path: relative file path
                   - line: line number in the file
                   - side: "RIGHT" (for additions/changes)
                   - body: severity emoji + message (ðŸ”´ high, ðŸŸ¡ medium, ðŸŸ¢ low)

                3. Submit the review using --input to pass JSON via stdin:
                   gh api -X POST repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews --input - <<'EOF'
                   {
                     "commit_id": "${{ github.event.pull_request.head.sha }}",
                     "body": "SUMMARY_TEXT",
                     "event": "COMMENT",
                     "comments": [JSON_ARRAY]
                   }
                   EOF

                4. If no inline comments but general issues exist, submit review with just summary body.

                5. If no issues at all, submit: "âœ… No issues found in this PR."
              </step>

            </protocol>

            Begin by getting the list of modified files from the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: '--allowed-tools "Task,Bash(gh api:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
