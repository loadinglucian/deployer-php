# Lima VM configuration for Debian 12 (Bookworm)
# Used for Deployer BATS integration testing

images:
  - location: "https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-amd64.qcow2"
    arch: "x86_64"
  - location: "https://cloud.debian.org/images/cloud/bookworm/latest/debian-12-generic-arm64.qcow2"
    arch: "aarch64"

cpus: 2
memory: "2GiB"
disk: "10GiB"

ssh:
  localPort: 2223
  loadDotSSHPubKeys: false

containerd:
  system: false
  user: false

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux

      # Prevent interactive prompts
      export DEBIAN_FRONTEND=noninteractive

      # Install essential packages
      apt-get update
      apt-get install -y \
        openssh-server \
        sudo \
        curl \
        wget \
        git \
        jq \
        rsync \
        supervisor \
        cron \
        ufw \
        gnupg \
        lsb-release \
        ca-certificates

      # Configure SSH for root login
      sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
      sed -i 's/PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
      sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
      echo "root:root" | chpasswd

      # Create deployer user with passwordless sudo
      if ! id deployer &>/dev/null; then
        useradd -m -s /bin/bash deployer
      fi
      echo "deployer ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/deployer
      chmod 0440 /etc/sudoers.d/deployer

      # Setup SSH directories
      mkdir -p /root/.ssh
      chmod 700 /root/.ssh

      # Create standard deployer directories
      mkdir -p /home/deployer/sites
      chown -R deployer:deployer /home/deployer

      # Restart SSH to apply changes
      systemctl restart sshd

  - mode: user
    script: |
      #!/bin/bash
      echo "Debian 12 VM provisioned for Deployer testing"
