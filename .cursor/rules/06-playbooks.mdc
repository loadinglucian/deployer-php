---
alwaysApply: true
---

## Playbook Rules

All rules MANDATORY.

### Core Principles

Playbooks are idempotent, non-interactive bash scripts that:

- Execute one or more related tasks
- MUST be idempotent (safe to run multiple times)
- Receive context via environment variables
- Never prompt for user input
- Run completely unattended
- Return parsable YAML output

### Structure

Standard playbook structure using `main()` function:

```bash
#!/usr/bin/env bash
set -o pipefail
export DEBIAN_FRONTEND=noninteractive

# Validation
[[ -z $DEPLOYER_OUTPUT_FILE ]] && echo "Error: DEPLOYER_OUTPUT_FILE required" && exit 1

#
# Helper Functions
# ----
# (see "Helper Functions" section below for run_cmd implementation)

#
# Main Execution
# ----

main() {
    echo "✓ Starting..."

    # Tasks go here

    if ! cat > "$DEPLOYER_OUTPUT_FILE" <<EOF; then
status: success
EOF
        echo "Error: Failed to write output file" >&2
        exit 1
    fi
}

main "$@"
```

**Pattern Requirements:**

- Shebang: `#!/usr/bin/env bash`
- Always set `set -o pipefail` (NOT `set -e`)
- Export `DEBIAN_FRONTEND=noninteractive`
- Validate `$DEPLOYER_OUTPUT_FILE` before any work
- Use `main()` function with `main "$@"` at bottom
- Group related functions with comment headers
- Check errors on YAML writes

### Environment Variables

Use `DEPLOYER_` prefix. Standard variables:

- `DEPLOYER_OUTPUT_FILE` - YAML output path (provided automatically)
- `DEPLOYER_DISTRO` - Distribution: `debian|redhat|amazon` (if needed)
- `DEPLOYER_PERMS` - Permissions: `root|sudo|none` (if needed)

**Validation:**

Detection playbooks only validate `DEPLOYER_OUTPUT_FILE`. Provisioning playbooks additionally validate `DEPLOYER_DISTRO` and `DEPLOYER_PERMS`, then export `DEPLOYER_PERMS` for subshell availability. See Complete Example section for full pattern.

### Distribution Support

Support Debian, RedHat, Amazon Linux. Use `case` statements for package operations:

```bash
# ✅ CORRECT - case statement for package managers
case $DEPLOYER_DISTRO in
    debian)
        run_cmd apt-get update -q
        run_cmd apt-get install -y -q "$package"
        ;;
    redhat|amazon)
        run_cmd yum install -y -q "$package"
        ;;
esac

# ❌ WRONG - Unnecessary branching for universal operations
case $DEPLOYER_DISTRO in
    debian|redhat|amazon)
        run_cmd systemctl start service  # Same everywhere!
        ;;
esac
```

**Universal operations (no branching needed):**

```bash
run_cmd systemctl start caddy
run_cmd systemctl enable caddy
run_cmd mkdir -p /var/www/app
```

### Non-Interactive Operation

Never prompt for input. Use non-interactive flags:

- `export DEBIAN_FRONTEND=noninteractive` (always set at top)
- Package managers: `-y -q` flags
- GPG operations: `--batch --yes`
- systemctl: `--quiet` (where appropriate)
- Never use `read`, confirm dialogs, or interactive prompts

### Idempotency

Check before acting. Don't fail if resource already exists:

```bash
# ✅ CORRECT - Idempotent patterns
if ! command -v caddy >/dev/null 2>&1; then
    run_cmd apt-get install -y -q caddy
fi

if [[ ! -d /var/www/app ]]; then
    run_cmd mkdir -p /var/www/app
fi

if ! systemctl is-enabled --quiet caddy; then
    run_cmd systemctl enable --quiet caddy
fi

# ❌ WRONG - Not idempotent
run_cmd useradd deployer  # Fails second time
echo "export PATH=\$PATH:/usr/local/bin" >> ~/.bashrc  # Duplicates each run
```

### Error Handling

Use `set -o pipefail` but NOT `set -e`. Check exit codes explicitly:

```bash
# Validation errors (before any work) → stdout
[[ -z $DEPLOYER_OUTPUT_FILE ]] && echo "Error: DEPLOYER_OUTPUT_FILE required" && exit 1

# Runtime errors (during execution) → stderr
if ! mkdir -p /var/www/app 2>&1; then
    echo "Error: Failed to create directory" >&2
    exit 1
fi

# Silent checks (expected to sometimes fail)
if ! command -v nginx >/dev/null 2>&1; then
    echo "✓ Installing nginx..."
    run_cmd apt-get install -y -q nginx
fi

# Check YAML writes
if ! cat > "$DEPLOYER_OUTPUT_FILE" <<EOF; then
status: success
EOF
    echo "Error: Failed to write output file" >&2
    exit 1
fi
```

**Error Detection:**

If playbook exits before creating `$DEPLOYER_OUTPUT_FILE`, framework treats all output as error message.

### Helper Functions

Standard helper for permission-aware command execution:

```bash
run_cmd() {
    if [[ $DEPLOYER_PERMS == 'root' ]]; then
        "$@"
    else
        sudo -n "$@"
    fi
}
```

The `-n` flag ensures sudo fails fast without prompting for a password, maintaining non-interactive operation.

### Output

Write YAML to `$DEPLOYER_OUTPUT_FILE`. Progress messages to stdout/stderr.

**Pattern:**

```bash
# Progress messages (stdout)
echo "✓ Processing..."
echo "✓ Task complete"

# YAML output to file (check for errors)
if ! cat > "$DEPLOYER_OUTPUT_FILE" <<EOF; then
status: success
distro: $DEPLOYER_DISTRO
result: []
EOF
    echo "Error: Failed to write output file" >&2
    exit 1
fi

# Error messages (stderr)
if ! some_command; then
    echo "Error: Command failed" >&2
    exit 1
fi
```

**Progress indicators:**

- `✓` for success messages
- `✗` for failure messages (before exit)
- Never write progress to output file

### Complete Example

```bash
#!/usr/bin/env bash
set -o pipefail
export DEBIAN_FRONTEND=noninteractive

# Validation
[[ -z $DEPLOYER_OUTPUT_FILE ]] && echo "Error: DEPLOYER_OUTPUT_FILE required" && exit 1
[[ -z $DEPLOYER_DISTRO ]] && echo "Error: DEPLOYER_DISTRO required" && exit 1
[[ -z $DEPLOYER_PERMS ]] && echo "Error: DEPLOYER_PERMS required" && exit 1
export DEPLOYER_PERMS

#
# Helper Functions
# ----

run_cmd() {
	if [[ $DEPLOYER_PERMS == 'root' ]]; then
		"$@"
	else
		sudo -n "$@"
	fi
}

#
# Main Execution
# ----

main() {
    local caddy_version

    echo "✓ Installing Caddy..."
    if ! command -v caddy >/dev/null 2>&1; then
        case $DEPLOYER_DISTRO in
            debian)
                run_cmd apt-get update -q
                run_cmd apt-get install -y -q caddy
                ;;
            redhat|amazon)
                run_cmd yum install -y -q caddy
                ;;
        esac
    fi

    echo "✓ Creating directory..."
    if [[ ! -d /var/www/app ]]; then
        run_cmd mkdir -p /var/www/app
    fi

    echo "✓ Enabling service..."
    if ! systemctl is-enabled --quiet caddy; then
        run_cmd systemctl enable --quiet caddy
    fi

    caddy_version=$(caddy version 2>&1 | cut -d' ' -f1)

    if ! cat > "$DEPLOYER_OUTPUT_FILE" <<EOF; then
status: success
distro: $DEPLOYER_DISTRO
caddy_version: $caddy_version
tasks_completed:
  - install_caddy
  - create_directory
  - enable_service
EOF
        echo "Error: Failed to write output file" >&2
        exit 1
    fi
}

main "$@"
```

See: `playbooks/server-info.sh`
