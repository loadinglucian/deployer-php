---
alwaysApply: true
---

## Symfony Console Rules

All rules MANDATORY. Fix violating code, not these rules.

### Output Method Philosophy

NEVER use Symfony IO methods directly - use BaseCommand methods exclusively.

All console output flows through custom methods in BaseCommand for consistent TUI styling.

**Custom IO Methods:**

```php
// Output
$this->writeln(['Multiple', 'lines']);
$this->io->hr();
$this->io->h1('Section Heading');

// Status messages
$this->success('Operation completed');     // Green checkmark
$this->error('Operation failed');          // Red X
$this->warning('Skipping step');           // Yellow warning
$this->info('Configuration loaded');       // Cyan info
```

**Missing a method?** Add to BaseCommand with modern styling.

**Integration Points:**

- Base: BaseCommand.php
- Output: ConsoleOutputTrait.php
- Input: ConsoleInputTrait.php
- Methods: `writeln()`, `info()`, `hr()`, `h1()`, `success()`, `error()`, `warning()`, `getOptionOrPrompt()`, `getValidatedOptionOrPrompt()`, `promptText()`, `promptPassword()`, `promptConfirm()`, `promptSelect()`, `promptMultiselect()`, `promptSuggest()`, `promptSearch()`, `promptPause()`, `promptSpin()`, `showCommandReplay()`

**Trait Organization:**

- ConsoleOutputTrait: Output/formatting methods using `$this->io` (SymfonyStyle)
- ConsoleInputTrait: Input methods using `$this->input` (InputInterface)
- BaseCommand: Shared initialization, configuration, orchestration (NOT individual I/O ops)

### User Input with Laravel Prompts

Use `laravel/prompts` for ALL user interactions:

```php
use function Laravel\Prompts\{text, password, confirm, select, multiselect, suggest, search, spin};

$name = text('What is your name?', required: true);
$password = password('Enter password:', required: true);
$confirmed = confirm('Deploy?', default: false);
$env = select('Environment:', ['dev', 'staging', 'prod']);
$features = multiselect('Features:', ['cache', 'queue', 'logs']);
$result = spin(fn() => $this->service->process(), 'Processing...');
```

Commands handle ALL user interaction. Services return plain data with NO console operations.

### Interactive + Options Pattern

Support both interactive prompts AND CLI options using `getOptionOrPrompt()`.

**Pattern:**

```php
protected function configure(): void {
    parent::configure();
    $this->addOption('name', null, InputOption::VALUE_REQUIRED, 'Server name');
    $this->addOption('host', null, InputOption::VALUE_REQUIRED, 'Host/IP address');
    $this->addOption('yes', 'y', InputOption::VALUE_NONE, 'Skip confirmation');
}

protected function execute(InputInterface $input, OutputInterface $output): int {
    // Checks CLI option first, prompts if not provided
    $name = $this->getOptionOrPrompt(
        'name',
        fn() => $this->promptText(
            label: 'Server name:',
            placeholder: 'production-web-01',
            required: true
        )
    );

    $host = $this->getOptionOrPrompt(
        'host',
        fn() => $this->promptText('Host/IP:', placeholder: '192.168.1.100', required: true)
    );

    $skipConfirm = $this->getOptionOrPrompt(
        'yes',
        fn() => $this->promptConfirm('Skip verification?', default: false)
    );

    // ... process command ...

    return Command::SUCCESS;
}
```

**Signature:** `getOptionOrPrompt(string $optionName, Closure $promptCallback): mixed`

Prompt wrappers (`promptText()`, `promptSelect()`, etc.) automatically suppress extra spacing for clean output.

### Input Validation Pattern

Validation traits provide reusable validation for both Laravel Prompts and CLI options.

**Validation Method Pattern:**

```php
// ✅ CORRECT - Accept mixed, return ?string (error message or null)
protected function validateNameInput(mixed $name): ?string
{
    if (!is_string($name)) {
        return 'Server name must be a string';
    }

    if (trim($name) === '') {
        return 'Server name cannot be empty';
    }

    if ($this->servers->findByName($name) !== null) {
        return "Server '{$name}' already exists";
    }

    return null;
}

// ❌ WRONG - Throws exception (incompatible with Laravel Prompts)
protected function validateName(string $name): void
{
    if (trim($name) === '') {
        throw new \InvalidArgumentException('Name cannot be empty');
    }
}
```

**Usage:**

```php
$name = $this->getValidatedOptionOrPrompt(
    'name',
    fn ($validate) => $this->promptText(
        label: 'Server name:',
        placeholder: 'web1',
        validate: $validate
    ),
    fn ($value) => $this->validateNameInput($value)
);

if ($name === null) {
    return Command::FAILURE;  // Validation failed, error already displayed
}
```

Validator injected into prompt callback, validates interactively and on CLI options.

**Naming Convention:**

- `validate*Input()` - Returns `?string` (for prompts/options)
- `validate*()` - Throws exceptions (for heavy I/O like git repo checks)

**Examples:** ServerValidationTrait.php, SiteValidationTrait.php

**Testing Validation Traits:**

```php
class TestValidator { use ServerValidationTrait;
    public function testValidateHost(mixed $host): ?string {
        return $this->validateHostInput($host);
    }
}

expect($validator->testValidateHost('192.168.1.100'))->toBeNull();
expect($validator->testValidateHost('invalid'))->toContain('valid');
```

### Command Options & Input

**Naming Convention Rules:**

| Option           | Usage                      | Type             | When                 |
| ---------------- | -------------------------- | ---------------- | -------------------- |
| `--server`       | Select existing server     | `VALUE_REQUIRED` | delete, info, deploy |
| `--site`         | Select existing site       | `VALUE_REQUIRED` | site operations      |
| `--name`         | Define new resource name   | `VALUE_REQUIRED` | add, create          |
| `--host`         | Host/IP address            | `VALUE_REQUIRED` | server config        |
| `--port`         | Port number                | `VALUE_REQUIRED` | server config        |
| `--yes` / `-y`   | Skip confirmation          | `VALUE_NONE`     | all confirmations    |
| `--force` / `-f` | Skip type-to-confirm       | `VALUE_NONE`     | delete commands      |
| `--skip`         | Skip validation            | `VALUE_NONE`     | validation steps     |

**Golden Rule:**

- `--server` / `--site`: SELECTING existing (operation target)
- `--name`: DEFINING new resource property

Prevents conflicts in commands working with multiple resource types.

**Additional Rules:**

- Use OPTIONS only, never ARGUMENTS (enables `getOptionOrPrompt()`)
- Pair all options with `getOptionOrPrompt()` for dual-mode support
- Boolean flags: `VALUE_NONE`
- Data inputs: `VALUE_REQUIRED`
- Only `--yes` (`-y`) and `--force` (`-f`) get short flags

See: ServerDeleteCommand.php, ServerAddCommand.php

### Command Completion

Always call `showCommandReplay()` before returning SUCCESS to teach non-interactive usage:

```php
$this->showCommandReplay('command:name', [
    'option1' => $value1,
    'option2' => $value2,
]);

return Command::SUCCESS;
```

Teaches CLI syntax, improves DX, reduces support questions.

**Output:**

```
◆ Run non-interactively:

  vendor/bin/deployer server:delete \
    --server='production-web-01' \
    --yes
```

See: ServerDeleteCommand.php
